version: "3.9"

volumes:
  mysql_data:
      driver: local
  documentdb_data:
      driver: local
  localstack_data:
      driver: local
    
services:

  # Telemetry, Metrics, and Monitoring
  jaeger:
    image: jaegertracing/all-in-one:latest
    volumes:
      - "./jaeger-ui.json:/etc/jaeger/jaeger-ui.json"
    command: --query.ui-config /etc/jaeger/jaeger-ui.json
    environment:
      - METRICS_STORAGE_TYPE=prometheus
      - PROMETHEUS_SERVER_URL=http://prometheus:9090
    ports:
      - "14250:14250"
      - "14268:14268"
      - "6831:6831/udp"
      - "16686:16686"
      - "16685:16685"
  otel_collector:
    image: otel/opentelemetry-collector-contrib:latest
    volumes:
      - "./otel-collector-config.yml:/etc/otelcol/otel-collector-config.yml"
    command: --config /etc/otelcol/otel-collector-config.yml
    ports:
      - "8889:8889"
      - "14278:14278"
    depends_on:
      - jaeger
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - "./prometheus.yml:/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"

  # Common Infrastructure Components
  eventsqueue:
    image: "nats"
    ports:
      - "4222:4222"
      - "8222:8222"
  docdb:
    image: "mongo:latest"
    ports:
      - "27017:27017"
    environment:
      - "MONGO_INITDB_ROOT_USERNAME=openreserveuser"
      - "MONGO_INITDB_ROOT_PASSWORD=openreservepass"
    volumes:
      - "documentdb_data:/data/db"
  localstack:
    image: "localstack/localstack"
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # external services port range
    environment:
      - DEBUG=1
      - PERSISTENCE=0
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "localstack_data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"

  # DWN Components
  collsvc:
    image: "openreserveio/collsvc:latest"
    build:
      context: "../../../go"
      dockerfile: "applications/pkg/Dockerfile-collsvc"
      tags:
        - "openreserveio/collsvc"
    ports:
      - "9001:9001"
    environment:
      - "DWN_COLLSVC.DOCDBCONNECTIONURI=mongodb://openreserveuser:openreservepass@docdb:27017"
      - "DWN_COLLSVC.LISTENPORT=9001"
      - "OPEN_TELEMETRY_COLLECTOR_URL=http://otel_collector:14278/api/traces"
  api:
    image: "openreserveio/api:latest"
    build:
      context: "../../../go"
      dockerfile: "applications/pkg/Dockerfile-api"
      tags:
        - "openreserveio/api"
    ports:
      - "8080:8080"
    environment:
      - "DWN_API.LISTENPORT=8080"
      - "DWN_COLLSVC.EXTERNALADDRESS=collsvc"
      - "DWN_COLLSVC.EXTERNALPORT=9001"
      - "OPEN_TELEMETRY_COLLECTOR_URL=http://otel_collector:14278/api/traces"
  